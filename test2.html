<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RO Classic - Chrono Equipment Refine Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Kanit', sans-serif; 
            /* ใส่รูปพื้นหลังเมืองที่เจนมาไว้ที่นี่ได้เลย */
            background-color: #1a202c;
            background-image: url('/images/refine/prontera_bg.jpg'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* ธีมหน้าต่าง UI สไตล์ RO */
        .ro-window {
            background: rgba(15, 23, 42, 0.85); /* สีน้ำเงินเข้มโปร่งแสง */
            border: 2px solid #475569;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7), inset 0 0 10px rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .ro-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid #334155;
        }

        .ro-button {
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
            border: 1px solid #60a5fa;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .ro-button:hover {
            background: linear-gradient(to bottom, #60a5fa, #2563eb);
        }

        .ro-text-shadow {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .log-container { max-height: 250px; overflow-y: auto; }
        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 4px; }
        .log-container::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        .log-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <div class="max-w-4xl w-full ro-window rounded-xl overflow-hidden text-slate-200">
        
        <!-- Header & NPC Dialog -->
        <div class="border-b border-slate-600 p-6 flex items-center space-x-5 bg-black/30">
            <!-- ใส่รูป Berlin.gif ที่นี่ -->
            <div class="relative w-20 h-20 rounded border-2 border-slate-500 bg-slate-800 flex-shrink-0 overflow-hidden shadow-lg">
                <img src="/images/refine/Berlin.gif" alt="Berlin Blacksmith" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/80?text=NPC'">
            </div>
            <div>
                <h1 class="text-2xl font-bold text-yellow-400 ro-text-shadow tracking-wide">Berlin Blacksmith</h1>
                <p class="text-slate-300 text-sm md:text-base mt-1 italic">"ข้าคือช่างตีเหล็กที่เก่งที่สุดในโลกนี้! เอาอุปกรณ์ของเจ้ามาสิ ข้าจะทำให้มันทรงพลังยิ่งกว่าเดิม! แต่เตรียม Zeny กับของมาให้พอด้วยล่ะ!"</p>
            </div>
        </div>

        <div class="p-6 md:p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left Column: Controls -->
            <div class="space-y-5">
                <!-- Equipment Info -->
                <div class="text-center p-6 ro-panel rounded-xl shadow-inner">
                    <p class="text-slate-400 text-sm font-medium mb-1">ระดับการอัพเกรดปัจจุบัน</p>
                    <div class="text-5xl font-bold text-yellow-400 ro-text-shadow" id="currentLevelDisplay">+0</div>
                    <div class="mt-3 text-sm text-slate-300 bg-black/40 py-2 px-4 rounded" id="nextRequirement">
                        (ขั้นถัดไป: โอกาส 100%, ใช้ 100,000 Zeny, 5 Medal)
                    </div>
                </div>

                <!-- Modifiers (Items) -->
                <div class="space-y-3">
                    <!-- God Hammer Checkbox -->
                    <label class="flex items-center p-3 ro-panel rounded-lg cursor-pointer hover:bg-slate-700 transition border border-transparent hover:border-slate-500">
                        <input type="checkbox" id="useGodHammer" class="w-5 h-5 text-blue-500 rounded border-slate-600 focus:ring-blue-500 focus:ring-offset-slate-800 bg-slate-800" onchange="updateRequirementText()">
                        <!-- รูป God Hammer -->
                        <img src="/images/refine/God_Hammer.png" alt="God Hammer" class="w-10 h-10 object-contain mx-3" onerror="this.src='https://via.placeholder.com/40?text=Hammer'">
                        <span class="flex-1">
                            <span class="block text-sm font-bold text-white ro-text-shadow">ใช้ God Hammer</span>
                            <span class="block text-xs text-green-400">+10% โอกาสสำเร็จ</span>
                        </span>
                    </label>

                    <!-- God Furnace Checkbox -->
                    <label class="flex items-center p-3 ro-panel rounded-lg cursor-pointer hover:bg-slate-700 transition border border-transparent hover:border-slate-500" id="furnaceContainer">
                        <input type="checkbox" id="useGodFurnace" class="w-5 h-5 text-blue-500 rounded border-slate-600 focus:ring-blue-500 focus:ring-offset-slate-800 bg-slate-800">
                        <!-- รูป God Furnace -->
                        <img src="/images/refine/God_Furnace.png" alt="God Furnace" class="w-10 h-10 object-contain mx-3" onerror="this.src='https://via.placeholder.com/40?text=Furnace'">
                        <span class="flex-1">
                            <span class="block text-sm font-bold text-white ro-text-shadow" id="furnaceTitle">ใช้ God Furnace</span>
                            <span class="block text-xs text-blue-300" id="furnaceLabelText">ป้องกันการลดขั้นเมื่อล้มเหลว</span>
                        </span>
                    </label>
                </div>

                <!-- Settings -->
                <div class="ro-panel rounded-xl p-4">
                    <h3 class="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider"><i class="fas fa-store mr-2"></i>ราคา Cash Shop (บาท)</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">God Hammer</label>
                            <div class="relative">
                                <input type="number" id="hammerPrice" value="75" min="0" class="w-full bg-slate-800 border border-slate-600 text-white p-2 rounded text-sm outline-none focus:border-blue-400 pl-8 transition" oninput="updateUI()">
                                <span class="absolute left-2 top-2 text-slate-500 text-sm">฿</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">God Furnace</label>
                            <div class="relative">
                                <input type="number" id="furnacePrice" value="75" min="0" class="w-full bg-slate-800 border border-slate-600 text-white p-2 rounded text-sm outline-none focus:border-blue-400 pl-8 transition" oninput="updateUI()">
                                <span class="absolute left-2 top-2 text-slate-500 text-sm">฿</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="space-y-3 pt-2">
                    <button id="btnRefine" onclick="refine()" class="w-full ro-button text-white font-bold py-3 px-4 rounded shadow-lg transition transform active:scale-95 flex justify-center items-center">
                        <i class="fas fa-gavel mr-2"></i> อัพเกรดอุปกรณ์ (Refine)
                    </button>
                    <button onclick="resetApp()" class="w-full bg-slate-700 hover:bg-slate-600 text-slate-200 border border-slate-500 font-semibold py-2 px-4 rounded shadow-lg transition">
                        <i class="fas fa-sync-alt mr-2"></i> รีเซ็ตข้อมูลทั้งหมด
                    </button>
                </div>
            </div>

            <!-- Right Column: Stats & Logs -->
            <div class="space-y-5 flex flex-col">
                <!-- Summary Stats -->
                <div class="ro-panel rounded-xl p-5 relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 opacity-10 text-6xl"><i class="fas fa-coins"></i></div>
                    <h3 class="text-sm font-bold text-slate-300 mb-3 border-b border-slate-600 pb-2"><i class="fas fa-chart-pie mr-2"></i>สรุปทรัพยากรที่ใช้ไป</h3>
                    <div class="grid grid-cols-2 gap-3 text-sm relative z-10">
                        <div class="flex justify-between flex-col bg-slate-800/80 p-2 border border-slate-700 rounded shadow-sm">
                            <span class="text-slate-400 text-xs">Zeny</span>
                            <span class="font-bold text-yellow-400" id="totalZeny">0</span>
                        </div>
                        <div class="flex justify-between flex-col bg-slate-800/80 p-2 border border-slate-700 rounded shadow-sm">
                            <span class="text-slate-400 text-xs">Mysterious Medal</span>
                            <span class="font-bold text-purple-400" id="totalMedal">0</span>
                        </div>
                        <div class="flex justify-between flex-col bg-slate-800/80 p-2 border border-slate-700 rounded shadow-sm">
                            <span class="text-slate-400 text-xs flex items-center"><img src="/images/refine/God_Hammer.png" class="w-4 h-4 mr-1 hidden md:block" onerror="this.style.display='none'">God Hammer</span>
                            <span class="font-bold text-orange-400" id="totalHammer">0</span>
                        </div>
                        <div class="flex justify-between flex-col bg-slate-800/80 p-2 border border-slate-700 rounded shadow-sm">
                            <span class="text-slate-400 text-xs flex items-center"><img src="/images/refine/God_Furnace.png" class="w-4 h-4 mr-1 hidden md:block" onerror="this.style.display='none'">God Furnace</span>
                            <span class="font-bold text-red-400" id="totalFurnace">0</span>
                        </div>
                        <div class="flex justify-between flex-col bg-green-900/40 p-3 rounded shadow-sm border border-green-700/50 col-span-2">
                            <span class="text-green-400 text-xs font-bold">รวมค่าใช้จ่าย Cash Shop (บาท)</span>
                            <span class="font-bold text-green-400 text-xl" id="totalBaht">0 ฿</span>
                        </div>
                        <div class="flex justify-between flex-col bg-blue-900/30 p-2 rounded shadow-sm border border-blue-800/50 col-span-2">
                            <span class="text-blue-300 text-xs">จำนวนครั้งที่ตีบวกทั้งหมด</span>
                            <span class="font-bold text-white text-lg" id="totalTry">0 ครั้ง</span>
                        </div>
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="ro-panel rounded-xl flex-1 flex flex-col overflow-hidden">
                    <div class="p-3 bg-black/40 border-b border-slate-600 text-sm font-bold text-slate-300">
                        <i class="fas fa-scroll mr-2"></i>ประวัติการตีบวก (System Log)
                    </div>
                    <div id="logArea" class="log-container p-3 space-y-2 text-sm flex-1 bg-slate-900/50">
                        <div class="text-slate-500 text-center italic mt-4">-- ยังไม่มีประวัติ --</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Overlay -->
    <div id="notification" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded border border-slate-600 shadow-2xl transition-opacity duration-300 opacity-0 pointer-events-none z-50 flex items-center">
        <i id="notifIcon" class="fas fa-info-circle mr-2 text-yellow-400"></i>
        <span id="notifText">Message</span>
    </div>

    <!-- Audio -->
    <audio id="sfxSuccess" src="https://www.myinstants.com/media/sounds/ro-refine-11484.mp3" preload="auto"></audio>
    <audio id="sfxFail" src="https://www.myinstants.com/media/sounds/ro-refine-failed-38779.mp3" preload="auto"></audio>

<script>
    // ==========================================
    const refineTable = {
        1: { chance: 96, zeny: 100000, medal: 10, furnaceReq: 0, safeLevel: 0 },
        2: { chance: 96, zeny: 100000, medal: 15, furnaceReq: 1, safeLevel: 0 },
        3: { chance: 96, zeny: 100000, medal: 20, furnaceReq: 1, safeLevel: 0 },
        4: { chance: 96, zeny: 100000, medal: 25, furnaceReq: 1, safeLevel: 0 },
        5: { chance: 70, zeny: 100000, medal: 35, furnaceReq: 0, safeLevel: 4 },
        6: { chance: 60, zeny: 200000, medal: 45, furnaceReq: 1, safeLevel: 4 },
        7: { chance: 50, zeny: 200000, medal: 55, furnaceReq: 1, safeLevel: 4 },
        8: { chance: 30, zeny: 200000, medal: 75, furnaceReq: 0, safeLevel: 7 },
        9: { chance: 30, zeny: 200000, medal: 95, furnaceReq: 1, safeLevel: 7 },
        10: { chance: 25, zeny: 200000, medal: 115, furnaceReq: 1, safeLevel: 7 },
        11: { chance: 25, zeny: 300000, medal: 155, furnaceReq: 0, safeLevel: 10 },
        12: { chance: 20, zeny: 300000, medal: 195, furnaceReq: 2, safeLevel: 10 },
        13: { chance: 20, zeny: 300000, medal: 250, furnaceReq: 2, safeLevel: 10 },
        14: { chance: 14, zeny: 300000, medal: 250, furnaceReq: 3, safeLevel: 10 },
        15: { chance: 14, zeny: 300000, medal: 250, furnaceReq: 3, safeLevel: 10 }
    };

    const MAX_LEVEL = 15;
    const sfxSuccess = document.getElementById('sfxSuccess');
    const sfxFail = document.getElementById('sfxFail');

    function playFallbackSound(isSuccess) {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            if (isSuccess) {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, ctx.currentTime);
                gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.5);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.5);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.3);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.3);
            }
        } catch (e) {
            console.log("Fallback audio failed", e);
        }
    }

    let state = { level: 0, zeny: 0, medal: 0, hammer: 0, furnace: 0, tries: 0 };

    function showNotification(message, type = 'info') {
        const notif = document.getElementById('notification');
        const notifText = document.getElementById('notifText');
        const notifIcon = document.getElementById('notifIcon');
        
        notifText.innerText = message;
        notifIcon.className = type === 'error' ? "fas fa-exclamation-triangle mr-2 text-red-500" : "fas fa-info-circle mr-2 text-yellow-400";
        notif.style.opacity = '1';
        setTimeout(() => notif.style.opacity = '0', 3000);
    }

    function addLog(message, isSuccess, currentLvl) {
        const logArea = document.getElementById('logArea');
        if(state.tries === 1) logArea.innerHTML = '';

        const logItem = document.createElement('div');
        logItem.className = `p-2 rounded border-l-4 bg-slate-800 ${isSuccess ? 'border-green-500' : 'border-red-500'}`;
        
        const icon = isSuccess ? '<i class="fas fa-arrow-up text-green-400 mr-1"></i>' : '<i class="fas fa-level-down-alt text-red-400 mr-1"></i>';
        
        logItem.innerHTML = `
            <div class="flex justify-between items-center text-slate-200">
                <span>${icon} อัพเกรดเป็น <strong>+${currentLvl}</strong></span>
                <span class="text-xs text-slate-500">ครั้งที่ ${state.tries}</span>
            </div>
            <div class="text-xs mt-1 text-slate-400">${message}</div>
        `;
        logArea.insertBefore(logItem, logArea.firstChild);
    }

    function updateRequirementText() {
        const reqText = document.getElementById('nextRequirement');
        const btnRefine = document.getElementById('btnRefine');

        if (state.level >= MAX_LEVEL) {
            reqText.innerHTML = `<span class="text-green-400 font-bold"><i class="fas fa-star mr-1"></i>ระดับสูงสุดแล้ว</span>`;
            btnRefine.disabled = true;
            btnRefine.className = "w-full bg-slate-600 text-slate-400 border border-slate-500 font-bold py-3 px-4 rounded shadow-lg flex justify-center items-center cursor-not-allowed";
            return;
        }

        const nextLevel = state.level + 1;
        const req = refineTable[nextLevel];
        const useHammer = document.getElementById('useGodHammer').checked;
        
        const furnaceCheckbox = document.getElementById('useGodFurnace');
        const furnaceTitle = document.getElementById('furnaceTitle');
        const furnaceLabelText = document.getElementById('furnaceLabelText');
        const furnaceContainer = document.getElementById('furnaceContainer');
        
        if (req.furnaceReq === 0) {
            furnaceCheckbox.checked = false;
            furnaceCheckbox.disabled = true;
            furnaceTitle.classList.add('text-slate-500');
            furnaceTitle.classList.remove('text-white');
            furnaceLabelText.innerText = `ระดับปลอดภัย (เมื่อล้มเหลวจะไม่ลดต่ำกว่า +${req.safeLevel})`;
            furnaceLabelText.classList.remove('text-blue-300');
            furnaceLabelText.classList.add('text-slate-500');
            furnaceContainer.classList.add('opacity-50');
        } else {
            furnaceCheckbox.disabled = false;
            furnaceTitle.classList.remove('text-slate-500');
            furnaceTitle.classList.add('text-white');
            furnaceLabelText.innerText = `ใช้ ${req.furnaceReq} ea เพื่อป้องกันการลดขั้น`;
            furnaceLabelText.classList.remove('text-slate-500');
            furnaceLabelText.classList.add('text-blue-300');
            furnaceContainer.classList.remove('opacity-50');
        }

        let displayChance = req.chance;
        if (useHammer) displayChance += 10;
        if (displayChance > 100) displayChance = 100;

        reqText.innerHTML = `ขั้นถัดไป +${nextLevel}: โอกาส <span class="${displayChance >= 50 ? 'text-green-400' : 'text-orange-400'} font-bold">${displayChance}%</span><br>ใช้ ${req.zeny.toLocaleString()} Z, ${req.medal} Medal`;
        
        btnRefine.disabled = false;
        btnRefine.className = "w-full ro-button text-white font-bold py-3 px-4 rounded shadow-lg transition transform active:scale-95 flex justify-center items-center";
    }

    function refine() {
        if (state.level >= MAX_LEVEL) return;

        const nextLevel = state.level + 1;
        const req = refineTable[nextLevel];

        const useHammer = document.getElementById('useGodHammer').checked;
        const useFurnace = document.getElementById('useGodFurnace').checked;

        state.zeny += req.zeny;
        state.medal += req.medal;
        state.tries += 1;
        if (useHammer) state.hammer += 1;
        if (useFurnace && req.furnaceReq > 0) state.furnace += req.furnaceReq;

        let currentChance = req.chance;
        if (useHammer) currentChance += 10;
        if (currentChance > 100) currentChance = 100;

        const roll = (Math.random() * 100).toFixed(2);
        let logMsg = "";
        let isSuccess = false;
        let attemptLevel = nextLevel;

        if (roll <= currentChance) {
            // สำเร็จ
            sfxSuccess.currentTime = 0;
            let playPromise = sfxSuccess.play();
            if (playPromise !== undefined) playPromise.catch(e => playFallbackSound(true));

            state.level += 1;
            isSuccess = true;
            logMsg = `สำเร็จ! โอกาส ${currentChance}% (สุ่มได้ ${roll})`;
            
            const lvlDisplay = document.getElementById('currentLevelDisplay');
            lvlDisplay.classList.add('text-white', 'scale-125');
            setTimeout(() => lvlDisplay.classList.remove('text-white', 'scale-125'), 300);

        } else {
            // ล้มเหลว
            sfxFail.currentTime = 0;
            let playPromise = sfxFail.play();
            if (playPromise !== undefined) playPromise.catch(e => playFallbackSound(false));

            isSuccess = false;
            if (useFurnace && req.furnaceReq > 0) {
                logMsg = `ล้มเหลว (สุ่มได้ ${roll}) <br><span class="text-blue-400">God Furnace ป้องกันการลดขั้น</span>`;
            } else {
                state.level = Math.max(req.safeLevel, state.level - 1);
                logMsg = `ล้มเหลว (สุ่มได้ ${roll}) <br><span class="text-red-400">อุปกรณ์ลดขั้นเหลือ +${state.level}</span>`;
                
                const lvlDisplay = document.getElementById('currentLevelDisplay');
                lvlDisplay.classList.replace('text-yellow-400', 'text-red-500');
                setTimeout(() => lvlDisplay.classList.replace('text-red-500', 'text-yellow-400'), 300);
            }
        }

        addLog(logMsg, isSuccess, attemptLevel);
        updateUI();
    }

    function resetApp() {
        state = { level: 0, zeny: 0, medal: 0, hammer: 0, furnace: 0, tries: 0 };
        document.getElementById('logArea').innerHTML = '<div class="text-slate-500 text-center italic mt-4">-- ยังไม่มีประวัติ --</div>';
        document.getElementById('useGodHammer').checked = false;
        document.getElementById('useGodFurnace').checked = false;
        updateUI();
        showNotification("รีเซ็ตข้อมูลทั้งหมดเรียบร้อยแล้ว");
    }

    function updateUI() {
        document.getElementById('currentLevelDisplay').innerText = `+${state.level}`;
        document.getElementById('totalZeny').innerText = state.zeny.toLocaleString();
        document.getElementById('totalMedal').innerText = state.medal.toLocaleString();
        document.getElementById('totalHammer').innerText = state.hammer.toLocaleString();
        document.getElementById('totalFurnace').innerText = state.furnace.toLocaleString();
        document.getElementById('totalTry').innerText = `${state.tries.toLocaleString()} ครั้ง`;
        
        const hammerPrice = parseFloat(document.getElementById('hammerPrice').value) || 0;
        const furnacePrice = parseFloat(document.getElementById('furnacePrice').value) || 0;
        const totalBaht = (state.hammer * hammerPrice) + (state.furnace * furnacePrice);
        document.getElementById('totalBaht').innerText = `${totalBaht.toLocaleString()} ฿`;
        
        updateRequirementText();
    }

    updateRequirementText();

</script>
</body>
</html>
